import java.io.*;
import java.net.*;
import java.util.*;
import java.nio.file.*;
import org.json.JSONArray;
import org.json.JSONObject;

public class ServiceStatusMatcher {
    public static void main(String[] args) {
        String csvInputPath = "pte_parameters.csv";
        String csvOutputPath = "service_status_matched.csv";
        String urlString = "your-url-here";
        String authToken = "your-auth-token-here";

        try {
            // Read service status from URL
            Map<String, ServiceStatus> serviceStatuses = fetchServiceStatus(urlString, authToken);
            
            // Read and process CSV
            List<String[]> matchedEntries = processCSV(csvInputPath, serviceStatuses);
            
            // Write matched entries to new CSV
            writeMatchedEntries(csvOutputPath, matchedEntries);
            
        } catch (Exception e) {
            System.out.println("Error: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private static Map<String, ServiceStatus> fetchServiceStatus(String urlString, String authToken) throws Exception {
        URL url = new URL(urlString);
        HttpURLConnection conn = (HttpURLConnection) url.openConnection();
        conn.setRequestMethod("GET");
        conn.setRequestProperty("Authorization", "Basic " + authToken);

        Map<String, ServiceStatus> serviceStatuses = new HashMap<>();
        
        if (conn.getResponseCode() == HttpURLConnection.HTTP_OK) {
            BufferedReader reader = new BufferedReader(new InputStreamReader(conn.getInputStream()));
            StringBuilder response = new StringBuilder();
            String line;
            
            while ((line = reader.readLine()) != null) {
                response.append(line);
            }
            reader.close();

            JSONArray jsonArray = new JSONArray(response.toString());
            for (int i = 0; i < jsonArray.length(); i++) {
                JSONObject service = jsonArray.getJSONObject(i);
                ServiceStatus status = new ServiceStatus(
                    service.getString("serviceName"),
                    service.getString("projectName"),
                    service.getInt("ready"),
                    service.getInt("running")
                );
                serviceStatuses.put(service.getString("serviceName"), status);
            }
        }
        
        conn.disconnect();
        return serviceStatuses;
    }

    private static List<String[]> processCSV(String csvPath, Map<String, ServiceStatus> serviceStatuses) throws Exception {
        List<String[]> matchedEntries = new ArrayList<>();
        
        BufferedReader reader = new BufferedReader(new FileReader(csvPath));
        
        // Read headers
        String headerLine = reader.readLine();
        String[] headers = headerLine.split(",");
        String[] newHeaders = Arrays.copyOf(headers, headers.length + 2);
        newHeaders[headers.length] = "Ready";
        newHeaders[headers.length + 1] = "Running";
        matchedEntries.add(newHeaders);
        
        String line;
        while ((line = reader.readLine()) != null) {
            // Split CSV line properly handling quoted values
            String[] values = splitCSVLine(line);
            String serviceName = values[0];
            String namespace = values[1];
            
            // Check if namespace contains "namicg" and service exists in status
            if (namespace.contains("namicg") && serviceStatuses.containsKey(serviceName)) {
                ServiceStatus status = serviceStatuses.get(serviceName);
                
                // Create new array with additional columns
                String[] newLine = Arrays.copyOf(values, values.length + 2);
                newLine[values.length] = String.valueOf(status.ready);
                newLine[values.length + 1] = String.valueOf(status.running);
                
                matchedEntries.add(newLine);
            }
        }
        
        reader.close();
        return matchedEntries;
    }

    private static void writeMatchedEntries(String outputPath, List<String[]> entries) throws Exception {
        BufferedWriter writer = new BufferedWriter(new FileWriter(outputPath));
        
        for (String[] entry : entries) {
            StringBuilder line = new StringBuilder();
            for (int i = 0; i < entry.length; i++) {
                if (i > 0) line.append(",");
                line.append(escapeCSV(entry[i]));
            }
            writer.write(line.toString());
            writer.newLine();
        }
        
        writer.close();
        System.out.println("Matched entries written to: " + outputPath);
    }

    private static String[] splitCSVLine(String line) {
        List<String> values = new ArrayList<>();
        StringBuilder currentValue = new StringBuilder();
        boolean inQuotes = false;
        
        for (char c : line.toCharArray()) {
            if (c == '"') {
                inQuotes = !inQuotes;
            } else if (c == ',' && !inQuotes) {
                values.add(currentValue.toString());
                currentValue = new StringBuilder();
            } else {
                currentValue.append(c);
            }
        }
        values.add(currentValue.toString());
        
        return values.toArray(new String[0]);
    }

    private static String escapeCSV(String value) {
        if (value == null) return "";
        if (value.contains(",") || value.contains("\"") || value.contains("\n")) {
            return "\"" + value.replace("\"", "\"\"") + "\"";
        }
        return value;
    }

    private static class ServiceStatus {
        String serviceName;
        String projectName;
        int ready;
        int running;

        ServiceStatus(String serviceName, String projectName, int ready, int running) {
            this.serviceName = serviceName;
            this.projectName = projectName;
            this.ready = ready;
            this.running = running;
        }
    }
}
